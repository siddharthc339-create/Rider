<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>রেস্টুরেন্ট প্যানেল | খিদে লাগছে</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f3f4f6; }
        .sidebar-active { border-left: 4px solid #ef4444; background: #fee2e2; color: #b91c1c; }
        .hidden-section { display: none; }
    </style>
</head>
<body>

    <!-- Alarm Sound -->
    <audio id="order-sound" preload="auto" loop>
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- New Order Notification Bar -->
    <div id="alarm-overlay" class="hidden fixed top-0 left-0 w-full bg-green-600 text-white p-4 z-[200] flex justify-between items-center shadow-lg">
        <p class="font-bold flex items-center gap-2"><i class="fas fa-utensils animate-bounce"></i> নতুন অর্ডার এসেছে!</p>
        <button onclick="stopAlarm()" class="bg-white text-green-600 px-6 py-2 rounded-full font-black text-sm">অর্ডার দেখুন</button>
    </div>

    <!-- Auth Screen (Login & Signup) -->
    <div id="login-screen" class="fixed inset-0 bg-red-600 flex items-center justify-center z-50 px-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-red-600 mb-2">খিদে লাগছে</h2>
            <p id="auth-title" class="text-center text-gray-500 mb-6 italic">পার্টনার লগইন</p>
            
            <!-- Login Form -->
            <div id="login-form">
                <input type="text" id="res-id-input" placeholder="রেস্টুরেন্ট আইডি" class="w-full p-4 mb-4 border rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                <input type="number" id="res-phone-input" placeholder="মোবাইল নম্বর" class="w-full p-4 mb-4 border rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                <button onclick="resLogin()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-red-700">লগইন</button>
                <p class="mt-4 text-center text-sm text-gray-600">অ্যাকাউন্ট নেই? <a href="#" onclick="toggleAuth(false)" class="text-red-600 font-bold underline">আবেদন করুন</a></p>
            </div>

            <!-- Signup Form (Request) -->
            <div id="signup-form" class="hidden">
                <input type="text" id="signup-name" placeholder="রেস্টুরেন্টের নাম" class="w-full p-4 mb-4 border rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                <input type="text" id="signup-owner" placeholder="মালিকের নাম" class="w-full p-4 mb-4 border rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                <input type="number" id="signup-phone" placeholder="মোবাইল নম্বর" class="w-full p-4 mb-4 border rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                <input type="text" id="signup-address" placeholder="ঠিকানা" class="w-full p-4 mb-4 border rounded-xl outline-none focus:ring-2 focus:ring-red-500">
                <button onclick="resSignup()" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-red-700">আবেদন জমা দিন</button>
                <p class="mt-4 text-center text-sm text-gray-600"><a href="#" onclick="toggleAuth(true)" class="text-red-600 font-bold underline">লগইন এ ফিরে যান</a></p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar -->
        <div class="w-full md:w-64 bg-white shadow-md z-10">
            <div class="p-6 border-b">
                <h1 id="display-res-name" class="text-xl font-black text-red-600 uppercase italic">RESTAURANT</h1>
                <p id="display-res-id" class="text-xs text-gray-400 font-bold"></p>
            </div>
            <nav class="mt-4">
                <button onclick="showSection('dashboard')" id="btn-dashboard" class="nav-btn w-full text-left px-6 py-4 flex items-center gap-3 sidebar-active"><i class="fas fa-chart-pie"></i> ড্যাশবোর্ড</button>
                <button onclick="showSection('orders')" id="btn-orders" class="nav-btn w-full text-left px-6 py-4 flex items-center gap-3 text-gray-700"><i class="fas fa-shopping-basket"></i> অর্ডারসমূহ</button>
                <button onclick="showSection('menu')" id="btn-menu" class="nav-btn w-full text-left px-6 py-4 flex items-center gap-3 text-gray-700"><i class="fas fa-utensils"></i> খাবারের মেনু</button>
                <button onclick="logout()" class="w-full text-left px-6 py-4 flex items-center gap-3 text-red-500 font-bold border-t mt-4"><i class="fas fa-sign-out-alt"></i> লগআউট</button>
            </nav>
        </div>

        <main class="flex-1 p-4 md:p-8">
            <!-- Dashboard Section -->
            <section id="sec-dashboard">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-red-500">
                        <p class="text-gray-400 text-xs font-bold uppercase">মোট বিক্রি</p>
                        <p class="text-3xl font-black text-gray-800" id="stat-res-revenue">৳ 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-b-4 border-blue-500">
                        <p class="text-gray-400 text-xs font-bold uppercase">মোট অর্ডার</p>
                        <p class="text-3xl font-black text-gray-800" id="stat-res-orders">0</p>
                    </div>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="sec-orders" class="hidden-section">
                <h2 class="text-2xl font-black mb-6">সাম্প্রতিক অর্ডার</h2>
                <div id="res-orders-list" class="grid gap-4">
                    <!-- Orders will be injected here -->
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="sec-menu" class="hidden-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black">মেনু ম্যানেজমেন্ট</h2>
                    <button onclick="addMenuItem()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold text-sm">+ নতুন খাবার যোগ করুন</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 text-xs font-bold uppercase">ছবি</th>
                                <th class="p-4 text-xs font-bold uppercase">খাবারের নাম</th>
                                <th class="p-4 text-xs font-bold uppercase">মূল্য</th>
                                <th class="p-4 text-xs font-bold uppercase text-right">অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table-body">
                            <!-- Menu items will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD_TytbX1kd4SKQ5uHZfd5XVGwdw0gzUOE",
            authDomain: "feeling-hungry-102a9.firebaseapp.com",
            databaseURL: "https://feeling-hungry-102a9-default-rtdb.firebaseio.com",
            projectId: "feeling-hungry-102a9",
            storageBucket: "feeling-hungry-102a9.firebasestorage.app",
            messagingSenderId: "736201265500",
            appId: "1:736201265500:web:7b7064b314247c02ad7199"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRes = null;
        let lastOrderCount = 0;

        // Toggle Login & Signup
        function toggleAuth(isLogin) {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('signup-form').classList.toggle('hidden', isLogin);
            document.getElementById('auth-title').innerText = isLogin ? "পার্টনার লগইন" : "পার্টনারশিপ আবেদন";
        }

        // Signup Function
        function resSignup() {
            const name = document.getElementById('signup-name').value;
            const owner = document.getElementById('signup-owner').value;
            const phone = document.getElementById('signup-phone').value;
            const address = document.getElementById('signup-address').value;

            if(!name || !owner || !phone || !address) return alert("সবগুলো ঘর পূরণ করুন!");

            const requestData = {
                name: name,
                owner: owner,
                phone: phone,
                address: address,
                approved: false,
                timestamp: Date.now()
            };

            db.ref('partners').push(requestData).then(() => {
                alert("আপনার আবেদনটি জমা হয়েছে। অ্যাডমিন অ্যাপ্রুভ করলে আপনি লগইন করতে পারবেন।");
                location.reload();
            });
        }

        // Login Function
        function resLogin() {
            const idNo = document.getElementById('res-id-input').value;
            const phone = document.getElementById('res-phone-input').value;

            db.ref('restaurants').once('value', snap => {
                const restaurants = snap.val();
                let found = false;
                for (let key in restaurants) {
                    if (restaurants[key].idNo === idNo && restaurants[key].phone === phone) {
                        currentRes = { ...restaurants[key], fireKey: key };
                        found = true;
                        break;
                    }
                }

                if (found) {
                    localStorage.setItem('res_session', JSON.stringify(currentRes));
                    startSession();
                } else {
                    alert("ভুল আইডি অথবা মোবাইল নম্বর!");
                }
            });
        }

        function startSession() {
            const session = localStorage.getItem('res_session');
            if (session) {
                currentRes = JSON.parse(session);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('display-res-name').innerText = currentRes.name;
                document.getElementById('display-res-id').innerText = "ID: " + currentRes.idNo;
                loadResData();
            }
        }

        function loadResData() {
            db.ref('orders').on('value', snap => {
                const allOrders = snap.val() || {};
                const resOrders = {};
                Object.keys(allOrders).forEach(id => {
                    if(allOrders[id].restaurantName === currentRes.name) resOrders[id] = allOrders[id];
                });

                if(Object.keys(resOrders).length > lastOrderCount && lastOrderCount !== 0) startAlarm();
                lastOrderCount = Object.keys(resOrders).length;
                renderOrders(resOrders);
            });

            db.ref(`menus/${currentRes.idNo}`).on('value', snap => {
                renderMenu(snap.val() || {});
            });
        }

        function renderOrders(orders) {
            const container = document.getElementById('res-orders-list');
            let revenue = 0;
            container.innerHTML = "";
            
            Object.keys(orders).reverse().forEach(id => {
                const order = orders[id];
                if(order.status === 'DELIVERED') revenue += parseFloat(order.total);
                
                container.innerHTML += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-gray-400">#${id.slice(-6)}</p>
                            <h3 class="font-black text-gray-800">${order.items ? order.items.map(i => i.name).join(', ') : 'নতুন অর্ডার'}</h3>
                            <p class="text-sm font-bold text-red-600">৳ ${order.total}</p>
                            <span class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold">${order.status}</span>
                        </div>
                        <button onclick="updateStatus('${id}', 'PREPARING')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Accept</button>
                    </div>`;
            });
            document.getElementById('stat-res-revenue').innerText = '৳ ' + revenue;
            document.getElementById('stat-res-orders').innerText = Object.keys(orders).length;
        }

        function renderMenu(menuData) {
            const container = document.getElementById('menu-table-body');
            container.innerHTML = "";
            Object.keys(menuData).forEach(id => {
                const item = menuData[id];
                container.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4"><img src="${item.image}" class="w-12 h-12 rounded-lg object-cover bg-gray-50"></td>
                        <td class="p-4 font-bold text-gray-800">${item.name}</td>
                        <td class="p-4 font-black text-red-600">৳${item.price}</td>
                        <td class="p-4 text-right">
                            <button onclick="deleteMenuItem('${id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function addMenuItem() {
            const name = prompt("খাবারের নাম লিখুন:");
            const price = prompt("মূল্য (৳) লিখুন:");
            const image = prompt("ছবির লিঙ্ক (URL) দিন:", "https://via.placeholder.com/150");

            if(name && price && image) {
                db.ref(`menus/${currentRes.idNo}`).push({
                    name: name,
                    price: price,
                    image: image
                }).then(() => alert("খাবার সফলভাবে যোগ করা হয়েছে!"));
            }
        }

        function deleteMenuItem(itemId) {
            if(confirm("আপনি কি এই খাবারটি মেনু থেকে মুছে ফেলতে চান?")) {
                db.ref(`menus/${currentRes.idNo}/${itemId}`).remove();
            }
        }

        function updateStatus(orderId, status) {
            db.ref(`orders/${orderId}`).update({ status: status });
        }

        function showSection(id) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById('sec-'+id).classList.remove('hidden-section');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('sidebar-active'));
            document.getElementById('btn-'+id).classList.add('sidebar-active');
        }

        function startAlarm() {
            document.getElementById('alarm-overlay').classList.remove('hidden');
            document.getElementById('order-sound').play().catch(e => {});
        }

        function stopAlarm() {
            document.getElementById('alarm-overlay').classList.add('hidden');
            document.getElementById('order-sound').pause();
            showSection('orders');
        }

        function logout() {
            localStorage.removeItem('res_session');
            location.reload();
        }

        window.onload = startSession;
    </script>
</body>
</html>